---
title: "Ordinal Model"
author: "Patrick Munger"
date: "Fall 2024"
output: html_document
---

# Agenda

1.  Estimate ordinal logit models (function `polr` from `MASS` package)
2.  Testing assumptions (Brandt for Proportional Odds)
3.  Estimate models that relax assumption (`clm` and `vglm`)
4.  Compute and plot predicted probabilities (function `ggpredict` from `ggeffects` package)
5.  Compute and plot Average Marginal Effects (function `avg_slopes` from `marginaleffects` package)

# Preliminaries

```{r include=FALSE}
# Set seed for replicability
set.seed(1234)
```

```{r include=FALSE}
# Load necessary libraries
library(tidyverse)        # Data manipulation and plotting
library(stargazer)        # LaTeX tables
library(MASS)             # For polr function
library(brant)            # For Brant test
library(ggeffects)        # For marginal effects and predictions
library(carData)          # Built-in datasets (including WVS)
library(marginaleffects)  # For computing marginal effects 
library(car)              # For PoTest
library(ordinal)          # For cumulative link model 
library(VGAM)             # For generalized ologit 
library(sjPlot)           # For results table with p-values 
```

# Data

First we'll load the World Values Survey Data from the `car` package.

```{r}
# Load the World Values Survey data from carData package 
data("WVS", package = "carData")
world_values <- WVS

# Check the dataset
summary(world_values)
```

Each observation of `poverty` is a survey response on a question about poverty.

"Do you think what the government is doing for poverty is about right, too much, or too little?"

The possible outcomes of `poverty` are:

1.  Too Little
2.  About Right
3.  Too Much

Some variables we will use as predictors:

-   `religion`: Member of a religion: 1 = no, 2 = yes
-   `degree`: Held a university degree: 1 = no, 2 = yes
-   `country`: Australia(1), Norway(2), Sweden(3), USA(4)
-   `age`: discrete year count
-   `gender`: 1 = female, 2 = male

Let's check the variables with `str()`

```{r}
str(world_values)
```

We need to make sure `poverty` is ordered in the `str()` output, since it will be the DV in an ologit l=model. In this case, it is already ordered ("Ord.factor). If not were not, we would want to run:

```{r}
# world_values$poverty <- factor(world_values$poverty, 
#                               levels = c("Too Little", "About Right", "Too Much"))
```

# Estimate Model

Now we estimate an ordered logit with the `polr()` function from the `MASS` package. We will estimate the effects of religion (binary), country (4 categories - Australia as reference), age (discrete numeric), and gender (binary) on the opinion on government poverty alleviation efforts (3 levels).

Syntax for specifying the model is very similar to `lm()` or `glm()`. Note that `Hess = TRUE` indicates that we want to variance-covariance matrix to be returned with the model (or technically the Hessian matrix, which is the inverse of the variance-covariance matrix in MLE). This is necessary for uncertainty estimates - so we will need this to get standard errors or p-values. Generally, if will "re-fit to get Hessian" even without thus arguement, but there is no harm in including it, and it might be necessary for some later functions.

```{r}
# Running the Ordered Logit Model
world_values_fit <- polr(poverty ~ religion + degree + country + age + gender, 
                         data = world_values, Hess = TRUE)

# Summarizing the model results - this will return standard errors
summary(world_values_fit)
```
